<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stage 2: Procurement Review</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1976d2;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-style: italic;
        }
        .navigation {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        .navigation a {
            color: #1976d2;
            text-decoration: none;
            margin: 0 15px;
            font-weight: bold;
        }
        .navigation a:hover {
            text-decoration: underline;
        }
        .mermaid-container {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .info-box {
            background-color: #fff3e0;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #f57c00;
        }
        .info-box h3 {
            margin-top: 0;
            color: #e65100;
        }
        .edit-permissions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        .perm-col {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
        }
        .perm-col h4 {
            margin-top: 0;
        }
        .can-edit {
            border-left: 4px solid #388e3c;
        }
        .cannot-edit {
            border-left: 4px solid #d32f2f;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Stage 2: Procurement Review</h1>
        <p class="subtitle">SUBMITTED Status - Procurement Team Reviews and Can Edit PR</p>
        
        <div class="navigation">
            <a href="PR_Flow_1_Creation.html">← Stage 1 (Creation)</a>
            <a href="PR_Flow_Master_Overview.html">Master Overview</a>
            <a href="PR_Flow_3_Queue_Processing.html">Next: Stage 3 (Queue Processing) →</a>
        </div>

        <div class="mermaid-container">
            <pre class="mermaid">
flowchart TB
    Entry[["← From STAGE 1:<br/>PR Status: SUBMITTED<br/>Notification sent to Procurement"]]
    
    Entry --> ProcReview{Procurement Review<br/>Status: SUBMITTED}
    
    %% Edit Loop
    ProcReview -->|Edit PR| EditPR[Edit PR Fields]
    EditPR --> EditDetails[Procurement can edit:<br/>• Organization<br/>• Department<br/>• Description<br/>• Site<br/>• Expense Type<br/>• Estimated Amount<br/>• Currency<br/>• Preferred Vendor<br/>• Line Items<br/>• Attachments]
    EditDetails --> CannotEdit[Cannot edit:<br/>• Created By<br/>• Created Date<br/>• Last Updated<br/>• Urgency Level<br/>• Required Date]
    CannotEdit --> SaveChanges[Save Changes]
    SaveChanges --> ProcReview
    
    %% Option 1: Move to Queue
    ProcReview -->|Option 1:<br/>Move to Queue| ConfirmQueue{Confirm Move<br/>to Queue?}
    ConfirmQueue -->|No| ProcReview
    ConfirmQueue -->|Yes| SetInQueue[Set Status: IN_QUEUE]
    SetInQueue --> NotifyQueue[Notify Requestor<br/>CC: Procurement]
    NotifyQueue --> ToStage3[["→ Continue to<br/>STAGE 3:<br/>Queue Processing"]]
    
    %% Option 2: Request Revision
    ProcReview -->|Option 2:<br/>Request Revision| NotesRevision{Notes<br/>Provided?}
    NotesRevision -->|No| ErrorNotes1[Error: Notes Required]
    ErrorNotes1 --> ProcReview
    NotesRevision -->|Yes| SetRevision[Set Status:<br/>REVISION_REQUIRED]
    SetRevision --> NotifyRequestorRev[Notify Requestor<br/>CC: Procurement]
    NotifyRequestorRev --> ToStage5Rev[["→ Continue to<br/>STAGE 5:<br/>Revision & Resubmission"]]
    
    %% Option 3: Reject PR
    ProcReview -->|Option 3:<br/>Reject PR| NotesReject{Notes<br/>Provided?}
    NotesReject -->|No| ErrorNotes2[Error: Notes Required]
    ErrorNotes2 --> ProcReview
    NotesReject -->|Yes| SetRejected[Set Status: REJECTED]
    SetRejected --> NotifyRequestorReject[Notify Requestor<br/>CC: Procurement]
    NotifyRequestorReject --> ToStage7[["→ Continue to<br/>STAGE 7:<br/>Terminal States"]]
    
    %% Requestor Cancellation (Far Right)
    Entry -.->|Requestor can<br/>cancel anytime| ReqCancel2{Cancel?}
    ReqCancel2 -.->|Yes| ReqCancelConfirm2[CANCELED<br/>by Requestor]
    ReqCancelConfirm2 -.-> ToStage7Cancel[["→ Stage 7"]]
    
    %% Styling
    classDef entryNode fill:#ffe0b2,stroke:#ef6c00,stroke-width:3px
    classDef reviewNode fill:#fff9c4,stroke:#f9a825,stroke-width:2px
    classDef editNode fill:#bbdefb,stroke:#1565c0,stroke-width:2px,stroke-dasharray: 5 5
    classDef processNode fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    classDef errorNode fill:#ffcdd2,stroke:#c62828,stroke-width:2px
    classDef nextStage fill:#ffe0b2,stroke:#ef6c00,stroke-width:3px
    
    classDef cancelNode fill:#ffebee,stroke:#c62828,stroke-width:1px,stroke-dasharray: 3 3
    
    class Entry entryNode
    class ProcReview,ConfirmQueue,NotesRevision,NotesReject reviewNode
    class EditPR,EditDetails,CannotEdit,SaveChanges editNode
    class SetInQueue,SetRevision,SetRejected,NotifyQueue,NotifyRequestorRev,NotifyRequestorReject processNode
    class ErrorNotes1,ErrorNotes2 errorNode
    class ReqCancel2,ReqCancelConfirm2 cancelNode
    class ToStage3,ToStage5Rev,ToStage7,ToStage7Cancel nextStage
            </pre>
        </div>

        <div class="info-box">
            <h3>Procurement Edit Permissions (SUBMITTED Status)</h3>
            <div class="edit-permissions">
                <div class="perm-col can-edit">
                    <h4>✅ CAN EDIT</h4>
                    <ul>
                        <li><strong>Organization</strong></li>
                        <li><strong>Department</strong></li>
                        <li><strong>Description</strong></li>
                        <li><strong>Site</strong></li>
                        <li><strong>Expense Type</strong></li>
                        <li><strong>Estimated Amount</strong></li>
                        <li><strong>Currency</strong></li>
                        <li><strong>Preferred Vendor</strong></li>
                        <li><strong>Line Items</strong> (add, edit, delete)</li>
                        <li><strong>Attachments</strong></li>
                        <li><strong>Vehicle</strong> (if applicable)</li>
                    </ul>
                </div>
                <div class="perm-col cannot-edit">
                    <h4>❌ CANNOT EDIT (Canonical Fields)</h4>
                    <ul>
                        <li><strong>Created By</strong> (requestor)</li>
                        <li><strong>Created Date</strong></li>
                        <li><strong>Last Updated</strong> (timestamp)</li>
                        <li><strong>Urgency Level</strong></li>
                        <li><strong>Required Date</strong></li>
                        <li><strong>PR Number</strong></li>
                        <li><strong>Approval History</strong></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="info-box" style="background-color: #e8f5e9; border-left-color: #388e3c;">
            <h3>Four Possible Outcomes from SUBMITTED Status</h3>
            <p><strong>Procurement Actions (3 options):</strong></p>
            <ol>
                <li>
                    <strong>Move to IN_QUEUE:</strong>
                    <ul>
                        <li>Procurement is satisfied with the PR</li>
                        <li>Status changes to IN_QUEUE</li>
                        <li>Proceeds to Stage 3 for quote validation and approver selection</li>
                        <li>No notes required</li>
                    </ul>
                </li>
                <li>
                    <strong>Request Revision:</strong>
                    <ul>
                        <li>Procurement needs requestor to make changes</li>
                        <li>Status changes to REVISION_REQUIRED</li>
                        <li><strong>Notes REQUIRED</strong> (validation enforced)</li>
                        <li>Notification sent to requestor</li>
                        <li>Proceeds to Stage 5 where requestor can edit and resubmit</li>
                    </ul>
                </li>
                <li>
                    <strong>Reject PR:</strong>
                    <ul>
                        <li>Procurement determines PR should not proceed</li>
                        <li>Status changes to REJECTED</li>
                        <li><strong>Notes REQUIRED</strong> (validation enforced)</li>
                        <li>Notification sent to requestor</li>
                        <li>PR is NOT deleted from database (audit trail preserved)</li>
                        <li>Proceeds to Stage 7 (Terminal State)</li>
                    </ul>
                </li>
            </ol>
            <p><strong>Requestor Action (1 option):</strong></p>
            <ol start="4">
                <li>
                    <strong>Cancel PR:</strong>
                    <ul>
                        <li>Only requestor can cancel at this stage</li>
                        <li>Status changes to CANCELED</li>
                        <li>Notes optional</li>
                        <li>Notification sent to procurement</li>
                        <li>PR is NOT deleted from database (audit trail preserved)</li>
                        <li>Proceeds to Stage 7 (Terminal State)</li>
                    </ul>
                </li>
            </ol>
        </div>

        <div class="info-box" style="background-color: #fce4ec; border-left-color: #c2185b;">
            <h3>Who Can Perform These Actions?</h3>
            <p><strong>Procurement Actions (Edit, Move to Queue, Request Revision, Reject):</strong></p>
            <ul>
                <li><strong>Level 3 (Procurement Officer):</strong> ✓ Can review, edit, and make all procurement decisions</li>
                <li><strong>Level 1 (Administrator):</strong> ✓ Full access to all actions (superuser)</li>
                <li><strong>Other Levels (2, 4, 5):</strong> ✗ CANNOT take procurement actions in SUBMITTED stage</li>
            </ul>
            <p><strong>Requestor Action (Cancel):</strong></p>
            <ul>
                <li><strong>Requestor (any level):</strong> ✓ Can cancel their own PR</li>
                <li><strong>Level 1 (Administrator):</strong> ✓ Can cancel any PR (superuser)</li>
            </ul>
            <p><strong>Important:</strong> Only Procurement Officers (Level 3) and Administrators (Level 1) can edit PRs and make procurement decisions in SUBMITTED status.</p>
            <p><strong>Iterative Editing:</strong> Procurement can edit the PR multiple times before choosing an outcome. Each edit updates the "Last Updated" timestamp automatically.</p>
        </div>

        <div class="info-box" style="background-color: #e3f2fd; border-left-color: #1976d2;">
            <h3>Notifications Triggered in This Stage</h3>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                <tr style="background-color: #bbdefb;">
                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Action</th>
                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Recipients</th>
                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Content</th>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;">Move to IN_QUEUE</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">Requestor</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">PR number, status change to IN_QUEUE, next steps</td>
                </tr>
                <tr style="background-color: #f9f9f9;">
                    <td style="padding: 10px; border: 1px solid #ddd;">Request Revision (Procurement)</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">Requestor</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">PR number, status change, procurement notes</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;">Reject PR (Procurement)</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">Requestor</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">PR number, status change, procurement notes, rejection reason</td>
                </tr>
                <tr style="background-color: #f9f9f9;">
                    <td style="padding: 10px; border: 1px solid #ddd;">Cancel PR (Requestor)</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">Procurement</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">PR number, status change, requestor notes (optional)</td>
                </tr>
            </table>
        </div>

        <div class="navigation" style="margin-top: 30px;">
            <a href="PR_Flow_1_Creation.html">← Stage 1 (Creation)</a>
            <a href="PR_Flow_Master_Overview.html">Master Overview</a>
            <a href="PR_Flow_3_Queue_Processing.html">Next: Stage 3 (Queue Processing) →</a>
        </div>
    </div>
</body>
</html>

