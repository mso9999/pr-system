<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stage 7: Terminal States</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true, theme: 'default', flowchart: { useMaxWidth: true, htmlLabels: true, curve: 'basis' }});
    </script>
    <style>
        body {font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5;}
        .container {max-width: 1400px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
        h1 {color: #1976d2; text-align: center; margin-bottom: 10px;}
        .subtitle {text-align: center; color: #666; margin-bottom: 30px; font-style: italic;}
        .navigation {background-color: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 20px; text-align: center;}
        .navigation a {color: #1976d2; text-decoration: none; margin: 0 15px; font-weight: bold;}
        .navigation a:hover {text-decoration: underline;}
        .mermaid-container {background-color: white; padding: 20px; border-radius: 5px; overflow-x: auto;}
        .info-box {background-color: #fff3e0; padding: 15px; border-radius: 5px; margin: 20px 0; border-left: 4px solid #f57c00;}
        .info-box h3 {margin-top: 0; color: #e65100;}
    </style>
</head>
<body>
    <div class="container">
        <h1>Stage 7: REJECTED & CANCELED States</h1>
        <p class="subtitle">PR Endpoints (with Resurrection Feature)</p>
        
        <div class="navigation">
            <a href="PR_Flow_Master_Overview.html">Master Overview</a>
            <a href="PR_Flow_2_Procurement_Review.html">Stage 2 (Procurement)</a>
            <a href="PR_Flow_4_Approval.html">Stage 4 (Approval)</a>
            <a href="PR_Flow_5_Revision.html">Stage 5 (Revision)</a>
        </div>

        <div class="mermaid-container">
            <pre class="mermaid">
flowchart TB
    %% Entry Points - CANCELED (Requestor only)
    EntryRequestorCancel2[["← From STAGE 2:<br/>Requestor canceled from SUBMITTED"]]
    EntryRequestorCancel3[["← From STAGE 3:<br/>Requestor canceled from IN_QUEUE"]]
    EntryRequestorCancel5[["← From STAGE 5:<br/>Requestor canceled<br/>instead of revising"]]
    
    %% Entry Points - REJECTED (Procurement or Approver)
    EntryProcReject[["← From STAGE 2:<br/>Procurement rejected PR<br/>with notes"]]
    EntryApproverReject[["← From STAGE 4:<br/>Approver rejected PR<br/>with notes"]]
    
    %% Canceled Path (Requestor only)
    EntryRequestorCancel2 --> RecordCancelReq[Record Cancellation:<br/>• Canceled by: Requestor<br/>• From stage<br/>• Optional notes<br/>• Timestamp]
    EntryRequestorCancel3 --> RecordCancelReq
    EntryRequestorCancel5 --> RecordCancelReq
    
    RecordCancelReq --> SetCanceled[Set Status: CANCELED]
    SetCanceled --> NotifyCancel[Notify Procurement<br/>& Approver if assigned<br/>CC: Requestor]
    NotifyCancel --> PreserveCancel[Preserve in Database<br/>for Audit Trail]
    PreserveCancel --> CanceledState{CANCELED<br/>Can be resurrected}
    
    %% Resurrection from CANCELED
    CanceledState -->|Requestor<br/>Resurrects| ResurrectCancel[Restore to SUBMITTED<br/>status only]
    ResurrectCancel --> NotifyResurrectCancel[Notify Procurement<br/>CC: Requestor<br/>PR resurrected]
    NotifyResurrectCancel --> BackToSubmitted([Return to Workflow<br/>at SUBMITTED status])
    
    CanceledState -->|No Action| EndCanceled([Remains: CANCELED])
    
    %% Rejected Path (Procurement or Approver)
    EntryProcReject --> RecordRejectProc[Record Rejection:<br/>• Rejected by: Procurement<br/>• Reason: Notes provided<br/>• Timestamp]
    EntryApproverReject --> RecordRejectApprover[Record Rejection:<br/>• Rejected by: Approver<br/>• Reason: Notes provided<br/>• Timestamp]
    
    RecordRejectProc --> SetRejected[Set Status: REJECTED]
    RecordRejectApprover --> SetRejected
    SetRejected --> NotifyReject[Notify Requestor<br/>CC: Procurement]
    NotifyReject --> PreserveReject[Preserve in Database<br/>for Audit Trail]
    PreserveReject --> RejectedState{REJECTED<br/>Can be resurrected}
    
    %% Resurrection from REJECTED
    RejectedState -->|Procurement/Admin<br/>Resurrects| ResurrectReject{Restore to highest<br/>status achieved<br/>before rejection}
    ResurrectReject --> ResurrectToStatus[Restore to:<br/>SUBMITTED, IN_QUEUE,<br/>or PENDING_APPROVAL<br/>whichever was highest]
    ResurrectToStatus --> NotifyResurrectReject[Notify Requestor<br/>& Approver if assigned<br/>CC: Procurement<br/>PR resurrected]
    NotifyResurrectReject --> BackToWorkflow([Return to Workflow<br/>at restored status])
    
    RejectedState -->|No Action| EndRejected([Remains: REJECTED])
    
    %% Styling
    classDef entryNode fill:#ffe0b2,stroke:#ef6c00,stroke-width:3px
    classDef processNode fill:#ffcdd2,stroke:#c62828,stroke-width:2px
    classDef statusNode fill:#ef9a9a,stroke:#b71c1c,stroke-width:2px
    classDef notifyNode fill:#e1bee7,stroke:#8e24aa,stroke-width:2px
    classDef endNode fill:#ffab91,stroke:#bf360c,stroke-width:3px
    
    class EntryRequestorCancel2,EntryRequestorCancel3,EntryRequestorCancel5,EntryProcReject,EntryApproverReject entryNode
    class RecordCancelReq,RecordRejectProc,RecordRejectApprover,PreserveCancel,PreserveReject,ResurrectCancel,ResurrectToStatus processNode
    class SetCanceled,SetRejected statusNode
    class NotifyCancel,NotifyReject,NotifyResurrectCancel,NotifyResurrectReject notifyNode
    class CanceledState,RejectedState,ResurrectReject decisionNode
    class EndCanceled,EndRejected,BackToSubmitted,BackToWorkflow endNode
    
    classDef decisionNode fill:#fff9c4,stroke:#f9a825,stroke-width:2px
            </pre>
        </div>

        <div class="info-box">
            <h3>CANCELED Status - Only Requestor Can Cancel</h3>
            <p><strong>Important: ONLY the requestor can CANCEL a PR.</strong> Procurement and Approvers can only REJECT.</p>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                <tr style="background-color: #ffcdd2;">
                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">From Stage/Status</th>
                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">When Can Requestor Cancel?</th>
                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Notes Required?</th>
                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Common Reasons</th>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>Stage 2: SUBMITTED</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd;">Yes - Any time during procurement review</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">Optional</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">No longer needed, duplicate submission</td>
                </tr>
                <tr style="background-color: #f9f9f9;">
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>Stage 3: IN_QUEUE</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd;">Yes - Any time during queue processing</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">Optional</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">No longer needed, project canceled</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>Stage 4: PENDING_APPROVAL</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd; background-color: #ffcdd2;"><strong>NO - Cannot cancel</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd;">N/A</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">Once with approver, only approver can reject</td>
                </tr>
                <tr style="background-color: #f9f9f9;">
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>Stage 5: REVISION_REQUIRED</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd;">Yes - Instead of revising</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">Optional</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">Too complex to fix, no longer needed</td>
                </tr>
            </table>
        </div>

        <div class="info-box" style="background-color: #ffebee; border-left-color: #c62828;">
            <h3>REJECTED Status - Procurement or Approver Decision</h3>
            <ul>
                <li><strong>Who Can Reject:</strong> Procurement (from Stage 2: SUBMITTED) OR Approvers (from Stage 4: PENDING_APPROVAL)</li>
                <li><strong>From Stages:</strong> Stage 2 (SUBMITTED) or Stage 4 (PENDING_APPROVAL)</li>
                <li><strong>Notes Required:</strong> YES - Approver must provide reason for rejection</li>
                <li><strong>Common Reasons:</strong>
                    <ul>
                        <li>Insufficient justification for purchase</li>
                        <li>Budget constraints</li>
                        <li>Alternative solution available</li>
                        <li>Quotes too high / not competitive</li>
                        <li>Policy or compliance issues</li>
                    </ul>
                </li>
                <li><strong>Not Recoverable:</strong> Once rejected, PR cannot be revised or resubmitted (must create new PR)</li>
            </ul>
        </div>

        <div class="info-box" style="background-color: #e8f5e9; border-left-color: #388e3c;">
            <h3>Difference: REJECTED vs CANCELED vs REVISION_REQUIRED</h3>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                <tr style="background-color: #c8e6c9;">
                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Status</th>
                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Can Be Fixed?</th>
                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Who Decides</th>
                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Meaning</th>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>REVISION_REQUIRED</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd; background-color: #c8e6c9;">✓ Yes - Requestor can edit & resubmit</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">Procurement or Approver</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">PR needs changes but is viable</td>
                </tr>
                <tr style="background-color: #f9f9f9;">
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>CANCELED</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd; background-color: #ffcdd2;">✗ No - Terminal state</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">Procurement, Requestor, or Admin</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">PR withdrawn, no longer needed</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>REJECTED</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd; background-color: #ffcdd2;">✗ No - Terminal state</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">Approver only</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">PR denied by approver, not approved</td>
                </tr>
            </table>
        </div>

        <div class="info-box" style="background-color: #c8e6c9; border-left-color: #2e7d32;">
            <h3>🔄 Resurrection Feature - PRs Can Be Restored</h3>
            <p><strong>REJECTED and CANCELED are no longer permanent terminal states!</strong> PRs can be resurrected under certain conditions:</p>
            
            <h4 style="color: #2e7d32;">Resurrection from REJECTED Status:</h4>
            <ul>
                <li><strong>Who Can Resurrect:</strong> Procurement Officers (Level 3) or Administrators (Level 1)</li>
                <li><strong>Restore To:</strong> The <em>highest status</em> the PR achieved before being rejected</li>
                <li><strong>Possible Restoration Points:</strong>
                    <ul>
                        <li>If rejected from SUBMITTED → Restore to SUBMITTED</li>
                        <li>If rejected after reaching IN_QUEUE → Restore to IN_QUEUE</li>
                        <li>If rejected from PENDING_APPROVAL → Restore to PENDING_APPROVAL</li>
                    </ul>
                </li>
                <li><strong>Use Case:</strong> Rejection was made in error, or circumstances changed making PR valid again</li>
                <li><strong>History:</strong> Rejection and resurrection are both recorded in audit trail</li>
            </ul>
            
            <h4 style="color: #2e7d32;">Resurrection from CANCELED Status:</h4>
            <ul>
                <li><strong>Who Can Resurrect:</strong> Original Requestor only (or Administrator Level 1)</li>
                <li><strong>Restore To:</strong> SUBMITTED status ONLY (regardless of where it was canceled from)</li>
                <li><strong>Use Case:</strong> Requestor changed their mind, or canceled by mistake</li>
                <li><strong>After Resurrection:</strong> PR returns to Stage 2 (Procurement Review) as if newly submitted</li>
                <li><strong>History:</strong> Cancellation and resurrection are both recorded in audit trail</li>
            </ul>
            
            <p><strong>Important Notes:</strong></p>
            <ul>
                <li>Resurrection triggers notification to relevant stakeholders</li>
                <li>All history (rejection/cancellation reason, who did it, when) is preserved</li>
                <li>Resurrected PRs continue with their original PR number</li>
                <li>Admin (Level 1) can resurrect any PR, regardless of type</li>
            </ul>
        </div>

        <div class="info-box" style="background-color: #e3f2fd; border-left-color: #1976d2;">
            <h3>Data Preservation & Audit Trail</h3>
            <ul>
                <li><strong>Never Deleted:</strong> PRs with CANCELED or REJECTED status are NEVER deleted from database</li>
                <li><strong>Full History:</strong> Complete audit trail preserved including:
                    <ul>
                        <li>All status changes and timestamps</li>
                        <li>Who canceled/rejected and when</li>
                        <li>Notes and reasons provided</li>
                        <li>All edits and revisions</li>
                        <li>Approver assignments</li>
                        <li>Original and updated data</li>
                    </ul>
                </li>
                <li><strong>Reporting:</strong> Canceled and rejected PRs included in analytics and reporting</li>
                <li><strong>Compliance:</strong> Preserved for audit, compliance, and historical reference</li>
                <li><strong>Metrics:</strong> Used to calculate rejection rates, cancellation reasons, etc.</li>
            </ul>
        </div>

        <div class="info-box" style="background-color: #fff3e0; border-left-color: #f57c00;">
            <h3>Notifications for Terminal States</h3>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                <tr style="background-color: #ffe0b2;">
                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Terminal State</th>
                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Primary Recipient</th>
                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">CC Recipients</th>
                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Information Included</th>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;">CANCELED (by Requestor)</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">Procurement</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">Approver (if assigned)</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">PR number, requestor canceled, optional notes, timestamp, from which stage</td>
                </tr>
                <tr style="background-color: #f9f9f9;">
                    <td style="padding: 10px; border: 1px solid #ddd;">REJECTED (by Procurement)</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">Requestor</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">-</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">PR number, rejection reason (notes), procurement officer, timestamp</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;">REJECTED (by Approver)</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">Requestor</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">Procurement</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">PR number, rejection reason (notes), approver name, timestamp</td>
                </tr>
            </table>
        </div>

        <div class="navigation" style="margin-top: 30px;">
            <a href="PR_Flow_Master_Overview.html">← Back to Master Overview</a>
        </div>
    </div>
</body>
</html>

