rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Reference data collections
    match /departments/{docId} {
      allow read, write: if true;
    }
    
    match /projectCategories/{docId} {
      allow read, write: if true;
    }
    
    match /sites/{docId} {
      allow read, write: if true;
    }
    
    match /expenseTypes/{docId} {
      allow read, write: if true;
    }
    
    match /vehicles/{docId} {
      allow read, write: if true;
    }
    
    match /vendors/{docId} {
      allow read, write: if true;
    }
    
    match /currencies/{docId} {
      allow read, write: if true;
    }

    // Purchase Requests collection
    match /purchaseRequests/{docId} {
      allow read: if request.auth != null;
      // Allow create for any authenticated user
      allow create: if request.auth != null;
      // Allow update if:
      // - You are the requestor, OR
      // - You have permissionLevel <= 4 (procurement, finance, admins)
      // NOTE: Users are stored by email, not UID!
      allow update: if request.auth != null &&
        (resource.data.requestorId == request.auth.uid ||
         get(/databases/$(database)/documents/users/$(request.auth.token.email)).data.permissionLevel <= 4);
      // Only admins can delete (permissionLevel <= 2)
      allow delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.token.email)).data.permissionLevel <= 2;
    }

    // Archive PRs collection (read-only for users, write for authenticated import scripts)
    match /archivePRs/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null; // Allow authenticated users to write (for import script)
    }

    // All other collections
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
