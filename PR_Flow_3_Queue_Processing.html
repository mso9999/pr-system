<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stage 3: Queue Processing</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
    <style>
        body {font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5;}
        .container {max-width: 1400px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
        h1 {color: #1976d2; text-align: center; margin-bottom: 10px;}
        .subtitle {text-align: center; color: #666; margin-bottom: 30px; font-style: italic;}
        .navigation {background-color: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 20px; text-align: center;}
        .navigation a {color: #1976d2; text-decoration: none; margin: 0 15px; font-weight: bold;}
        .navigation a:hover {text-decoration: underline;}
        .mermaid-container {background-color: white; padding: 20px; border-radius: 5px; overflow-x: auto;}
        .info-box {background-color: #fff3e0; padding: 15px; border-radius: 5px; margin: 20px 0; border-left: 4px solid #f57c00;}
        .info-box h3 {margin-top: 0; color: #e65100;}
    </style>
</head>
<body>
    <div class="container">
        <h1>Stage 3: Queue Processing</h1>
        <p class="subtitle">IN_QUEUE Status - Quote Validation & Approver Selection</p>
        
        <div class="navigation">
            <a href="PR_Flow_2_Procurement_Review.html">← Stage 2 (Procurement Review)</a>
            <a href="PR_Flow_Master_Overview.html">Master Overview</a>
            <a href="PR_Flow_4_Approval.html">Next: Stage 4 (Approval) →</a>
        </div>

        <div class="mermaid-container">
            <pre class="mermaid">
flowchart TB
    Entry[["← From STAGE 2:<br/>PR Status: IN_QUEUE"]]
    
    Entry --> ProcQueueReview{Procurement Review<br/>Status: IN_QUEUE}
    
    %% Procurement Edit Capability Loop (same as SUBMITTED)
    ProcQueueReview -->|Edit PR| EditPRQueue[Edit PR Fields]
    EditPRQueue --> EditDetailsQueue[Procurement can edit:<br/>• Organization<br/>• Department<br/>• Description<br/>• Site<br/>• Expense Type<br/>• Estimated Amount<br/>• Currency<br/>• Preferred Vendor<br/>• Line Items<br/>• Attachments]
    EditDetailsQueue --> CannotEditQueue[Cannot edit:<br/>• Created By<br/>• Created Date<br/>• Last Updated<br/>• Urgency Level<br/>• Required Date]
    CannotEditQueue --> SaveChangesQueue[Save Changes]
    SaveChangesQueue --> ProcQueueReview
    
    ProcQueueReview -->|Proceed with<br/>Quote Validation| CheckThreshold{Check Amount vs<br/>Rule 2 Threshold}
    
    %% Rule 2 - Above Threshold
    CheckThreshold -->|Above Rule 2| Rule2Above[Require: 3 quotes<br/>with attachments<br/>TWO Level 2 approvers<br/>concurrent approval]
    
    %% Rule 2 - Below, Check Rule 1
    CheckThreshold -->|Below Rule 2| CheckRule1{Check Amount vs<br/>Rule 1 Threshold}
    
    %% Rule 1 - Above Threshold
    CheckRule1 -->|Above Rule 1| CheckVendor1{Using Approved<br/>Vendor?}
    CheckVendor1 -->|Yes| Rule1AboveApproved[Require: 1 quote<br/>with attachment<br/>Level 2 approver only]
    CheckVendor1 -->|No| Rule1AboveNoApproved[Require: 3 quotes<br/>with attachments<br/>Level 2 approver only]
    
    %% Rule 1 - Below Threshold
    CheckRule1 -->|Below Rule 1| CheckVendorBelow{Using Approved<br/>Vendor?}
    CheckVendorBelow -->|Yes| Rule1BelowApproved[Require: 1 quote<br/>attachment optional<br/>vendor data from system<br/>Level 4 or Level 2 approver]
    CheckVendorBelow -->|No| Rule1BelowNonApproved[Require: 1 quote<br/>attachment optional<br/>Procurement must input:<br/>• Supplier name<br/>• Contact phone/email/website]
    
    Rule1BelowNonApproved --> ValidateSupplierData{Supplier Data<br/>Entered?<br/>• Name<br/>• Contact info}
    ValidateSupplierData -->|No| SupplierDataError[Error: Supplier<br/>data required]
    SupplierDataError --> Rule1BelowNonApproved
    ValidateSupplierData -->|Yes| Rule1BelowValidated[Supplier data validated<br/>Level 4 or Level 2 approver]
    
    %% Validate Quotes
    Rule2Above --> ValidateQuotes{Quotes Valid?<br/>• Correct number?<br/>• Attachments present?<br/>• Amounts valid?}
    Rule1AboveApproved --> ValidateQuotes
    Rule1AboveNoApproved --> ValidateQuotes
    Rule1BelowApproved --> ValidateQuotes
    Rule1BelowValidated --> ValidateQuotes
    
    ValidateQuotes -->|Invalid/Incomplete| QuoteError[Notify Procurement:<br/>Additional quotes needed]
    QuoteError --> Entry
    
    ValidateQuotes -->|Valid| SelectApprover[Select Appropriate<br/>Approver]
    
    %% Validate Approver
    SelectApprover --> CheckApproverLevel{Approver Level<br/>Matches Requirements?}
    CheckApproverLevel -->|No| ApproverError1[Error: Wrong<br/>approver level]
    ApproverError1 --> SelectApprover
    
    CheckApproverLevel -->|Yes| CheckApproverOrg{Approver Org<br/>Matches PR Org?}
    CheckApproverOrg -->|No| ApproverError2[Error: Org mismatch]
    ApproverError2 --> SelectApprover
    
    CheckApproverOrg -->|Yes| CheckApproverActive{Approver<br/>Active?}
    CheckApproverActive -->|No| ApproverError3[Error: Inactive<br/>approver]
    ApproverError3 --> SelectApprover
    
    CheckApproverActive -->|Yes| CheckSelfApproval{Approver is<br/>Requestor?}
    CheckSelfApproval -->|Yes| ApproverError4[Error: Cannot<br/>self-approve]
    ApproverError4 --> SelectApprover
    
    CheckSelfApproval -->|No| CheckRule2Approvers{PR Above<br/>Rule 2 Threshold?}
    CheckRule2Approvers -->|Yes| SelectTwoApprovers[Assign TWO Level 2<br/>Approvers for<br/>Concurrent Approval]
    CheckRule2Approvers -->|No| SelectOneApprover[Assign ONE Approver<br/>Level 2 or Level 4]
    
    SelectTwoApprovers --> PushToApprover1[Set Status:<br/>PENDING_APPROVAL<br/>Assign Both Approvers]
    SelectOneApprover --> PushToApprover[Set Status:<br/>PENDING_APPROVAL<br/>Assign Approver]
    
    PushToApprover1 --> NotifyBothApprovers[Notify BOTH Approvers<br/>Concurrently<br/>CC: Requestor & Procurement<br/>Note: 2 approvals required]
    PushToApprover --> NotifyApprover[Notify Approver<br/>CC: Requestor & Procurement]
    
    NotifyBothApprovers --> ToStage4
    NotifyApprover --> ToStage4[["→ Continue to<br/>STAGE 4:<br/>Approval Process"]]
    
    %% Requestor Cancellation (Far Right)
    Entry -.->|Requestor can<br/>cancel anytime| ReqCancel3{Cancel?}
    ReqCancel3 -.->|Yes| ReqCancelConfirm3[CANCELED<br/>by Requestor]
    ReqCancelConfirm3 -.-> ToStage7[["→ Stage 7"]]
    
    %% Styling
    classDef entryNode fill:#ffe0b2,stroke:#ef6c00,stroke-width:3px
    classDef decisionNode fill:#fff9c4,stroke:#f9a825,stroke-width:2px
    classDef ruleNode fill:#e1bee7,stroke:#8e24aa,stroke-width:2px
    classDef errorNode fill:#ffcdd2,stroke:#c62828,stroke-width:2px
    classDef processNode fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    classDef nextStage fill:#ffe0b2,stroke:#ef6c00,stroke-width:3px
    
    classDef cancelNode fill:#ffebee,stroke:#c62828,stroke-width:1px,stroke-dasharray: 3 3
    classDef editNode fill:#bbdefb,stroke:#1565c0,stroke-width:2px,stroke-dasharray: 5 5
    
    class Entry entryNode
    class ProcQueueReview,CheckThreshold,CheckRule1,CheckVendor1,CheckVendorBelow,ValidateSupplierData,ValidateQuotes,CheckApproverLevel,CheckApproverOrg,CheckApproverActive,CheckSelfApproval,CheckRule2Approvers decisionNode
    class Rule2Above,Rule1AboveApproved,Rule1AboveNoApproved,Rule1BelowApproved,Rule1BelowNonApproved,Rule1BelowValidated ruleNode
    class QuoteError,SupplierDataError,ApproverError1,ApproverError2,ApproverError3,ApproverError4 errorNode
    class EditPRQueue,EditDetailsQueue,CannotEditQueue,SaveChangesQueue editNode
    class SelectApprover,SelectTwoApprovers,SelectOneApprover,PushToApprover,PushToApprover1,NotifyApprover,NotifyBothApprovers processNode
    class ReqCancel3,ReqCancelConfirm3 cancelNode
    class ToStage4,ToStage7 nextStage
            </pre>
        </div>

        <div class="info-box">
            <h3>Quote Requirements - Rule 1 & Rule 2</h3>
            <p><strong>Rule 2 (Higher Threshold):</strong></p>
            <ul>
                <li><strong>Above threshold:</strong> Always requires:
                    <ul>
                        <li>3 quotes with attachments</li>
                        <li><strong>TWO Level 2 approvers (concurrent - both notified simultaneously)</strong></li>
                        <li>NO exceptions for approved vendors</li>
                        <li>Both approvers must approve for PR to proceed</li>
                        <li>Approvers can review in any order</li>
                    </ul>
                </li>
                <li><strong>Below threshold:</strong> Rule 1 applies</li>
            </ul>
            <p><strong>Rule 1 (Lower Threshold):</strong></p>
            <ul>
                <li><strong>Below threshold:</strong> 1 quote required, attachment optional, Level 4 or Level 2 approver
                    <ul>
                        <li><strong>If approved vendor:</strong> Vendor data referenced from system</li>
                        <li><strong>If NOT approved vendor:</strong> Procurement must manually input:
                            <ul>
                                <li>Supplier name (required)</li>
                                <li>Contact information: phone OR email OR website (at least one required)</li>
                                <li>This data is NOT collected during PR creation</li>
                                <li>Validation check before moving to PENDING_APPROVAL</li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li><strong>Above threshold:</strong>
                    <ul>
                        <li>Approved vendor: 1 quote with attachment, Level 2 approver only</li>
                        <li>Non-approved vendor: 3 quotes with attachments, Level 2 approver only</li>
                    </ul>
                </li>
            </ul>
        </div>

        <div class="info-box" style="background-color: #e3f2fd; border-left-color: #1976d2;">
            <h3>Procurement Edit Permissions (IN_QUEUE Status)</h3>
            <p><strong>Same edit capabilities as SUBMITTED status:</strong></p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                <div style="background-color: white; padding: 15px; border-radius: 5px; border-left: 4px solid #388e3c;">
                    <h4 style="margin-top: 0;">✅ CAN EDIT</h4>
                    <ul style="margin: 0;">
                        <li><strong>Organization</strong></li>
                        <li><strong>Department</strong></li>
                        <li><strong>Description</strong></li>
                        <li><strong>Site</strong></li>
                        <li><strong>Expense Type</strong></li>
                        <li><strong>Estimated Amount</strong></li>
                        <li><strong>Currency</strong></li>
                        <li><strong>Preferred Vendor</strong></li>
                        <li><strong>Line Items</strong> (add, edit, delete)</li>
                        <li><strong>Attachments</strong></li>
                        <li><strong>Vehicle</strong> (if applicable)</li>
                    </ul>
                </div>
                <div style="background-color: white; padding: 15px; border-radius: 5px; border-left: 4px solid #d32f2f;">
                    <h4 style="margin-top: 0;">❌ CANNOT EDIT (Canonical Fields)</h4>
                    <ul style="margin: 0;">
                        <li><strong>Created By</strong> (requestor)</li>
                        <li><strong>Created Date</strong></li>
                        <li><strong>Last Updated</strong> (timestamp)</li>
                        <li><strong>Urgency Level</strong></li>
                        <li><strong>Required Date</strong></li>
                        <li><strong>PR Number</strong></li>
                        <li><strong>Approval History</strong></li>
                    </ul>
                </div>
            </div>
            <p style="margin-top: 15px;"><strong>Who Can Edit:</strong> Only Procurement Officers (Level 3) and Administrators (Level 1)</p>
            <p><strong>Purpose:</strong> Procurement may need to adjust PR details during quote validation and supplier data collection before pushing to approver.</p>
        </div>

        <div class="info-box" style="background-color: #fff3e0; border-left-color: #f57c00;">
            <h3>Supplier Data Collection (Stage 3 - IN_QUEUE)</h3>
            <p><strong>Important:</strong> Supplier information is NOT collected during PR creation (Stage 1). It is collected and attached to the PR during Stage 3 (IN_QUEUE) processing.</p>
            
            <h4>For Approved Vendors:</h4>
            <ul>
                <li>Vendor data is automatically referenced from existing vendor object in system</li>
                <li>No manual data entry required</li>
                <li>Vendor details (name, contact info) already in database</li>
            </ul>
            
            <h4>For Non-Approved Vendors (below Rule 1 threshold):</h4>
            <ul>
                <li><strong>Procurement team must manually input the following:</strong></li>
                <li><strong>Required Fields:</strong>
                    <ul>
                        <li>Supplier Name</li>
                        <li>Contact Information (at least ONE of the following):
                            <ul>
                                <li>Phone number, OR</li>
                                <li>Email address, OR</li>
                                <li>Website URL (if supplier is a platform)</li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li><strong>Validation:</strong> System validates that supplier name and at least one contact method are entered</li>
                <li><strong>Blocking:</strong> PR cannot move to PENDING_APPROVAL until supplier data is complete</li>
                <li><strong>Data Storage:</strong> Supplier data is attached to the PR object for audit trail and future reference</li>
            </ul>
            
            <p><strong>Why this matters:</strong> For low-value PRs with non-approved vendors, we still need basic supplier information for tracking, communication, and audit purposes, even though formal vendor approval is not required.</p>
        </div>

        <div class="info-box" style="background-color: #e8f5e9; border-left-color: #388e3c;">
            <h3>Approver Validation Rules</h3>
            <ol>
                <li><strong>Level Match:</strong> Approver must have correct permission level (Level 2 for high-value, Level 2 or 4 for low-value)</li>
                <li><strong>Organization Match:</strong> Approver must be assigned to same organization as PR (primary or additional organizations)</li>
                <li><strong>Active Status:</strong> Approver must have isActive = true</li>
                <li><strong>No Self-Approval:</strong> Approver cannot be the same user as the requestor</li>
                <li><strong>Currency Conversion:</strong> All amounts converted to organization's base currency for threshold comparison</li>
            </ol>
        </div>

        <div class="navigation" style="margin-top: 30px;">
            <a href="PR_Flow_2_Procurement_Review.html">← Stage 2 (Procurement Review)</a>
            <a href="PR_Flow_Master_Overview.html">Master Overview</a>
            <a href="PR_Flow_4_Approval.html">Next: Stage 4 (Approval) →</a>
        </div>
    </div>
</body>
</html>

