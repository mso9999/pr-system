<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stage 5: Revision & Resubmission</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true, theme: 'default', flowchart: { useMaxWidth: true, htmlLabels: true, curve: 'basis' }});
    </script>
    <style>
        body {font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5;}
        .container {max-width: 1400px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
        h1 {color: #1976d2; text-align: center; margin-bottom: 10px;}
        .subtitle {text-align: center; color: #666; margin-bottom: 30px; font-style: italic;}
        .navigation {background-color: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 20px; text-align: center;}
        .navigation a {color: #1976d2; text-decoration: none; margin: 0 15px; font-weight: bold;}
        .navigation a:hover {text-decoration: underline;}
        .mermaid-container {background-color: white; padding: 20px; border-radius: 5px; overflow-x: auto;}
        .info-box {background-color: #fff3e0; padding: 15px; border-radius: 5px; margin: 20px 0; border-left: 4px solid #f57c00;}
        .info-box h3 {margin-top: 0; color: #e65100;}
        .edit-permissions {display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;}
        .perm-col {background-color: white; padding: 15px; border-radius: 5px;}
        .perm-col h4 {margin-top: 0;}
        .can-edit {border-left: 4px solid #388e3c;}
        .cannot-edit {border-left: 4px solid #d32f2f;}
        .comparison {background-color: #e1f5fe; padding: 15px; border-radius: 5px; margin-top: 15px;}
    </style>
</head>
<body>
    <div class="container">
        <h1>Stage 5: Revision & Resubmission</h1>
        <p class="subtitle">REVISION_REQUIRED Status - Requestor Edits PR and Resubmits</p>
        
        <div class="navigation">
            <a href="PR_Flow_4_Approval.html">← Stage 4 (Approval)</a>
            <a href="PR_Flow_Master_Overview.html">Master Overview</a>
            <a href="PR_Flow_2_Procurement_Review.html">Returns to: Stage 2 (Procurement Review) →</a>
        </div>

        <div class="mermaid-container">
            <pre class="mermaid">
flowchart TB
    EntryProc[["← From STAGE 2:<br/>Procurement requested revision"]]
    EntryApprover[["← From STAGE 4:<br/>Approver requested revision"]]
    
    EntryProc --> ViewNotes[View Revision Notes<br/>from Procurement/Approver]
    EntryApprover --> ViewNotes
    
    ViewNotes --> RequestorReview{Requestor<br/>Reviews PR}
    
    %% Edit Loop
    RequestorReview -->|Edit PR| EditPR[Edit PR Fields]
    EditPR --> EditDetails[Requestor can edit:<br/>• Organization<br/>• Department<br/>• Description<br/>• Site<br/>• Expense Type<br/>• Estimated Amount<br/>• Currency<br/>• Urgency Level ✓<br/>• Required Date ✓<br/>• Preferred Vendor<br/>• Line Items<br/>• Attachments]
    EditDetails --> CannotEdit[Cannot edit:<br/>• Created By<br/>• Created Date<br/>• History/Audit Trail<br/>• PR Number]
    CannotEdit --> SaveChanges[Save Changes]
    SaveChanges --> RequestorReview
    
    %% Resubmit
    RequestorReview -->|Resubmit| ValidateChanges{Validation:<br/>All fields valid?}
    ValidateChanges -->|Invalid| ShowErrors[Show Validation Errors]
    ShowErrors --> EditPR
    ValidateChanges -->|Valid| SetResubmitted[Set Status: RESUBMITTED<br/>Update Last Modified<br/>Add to history]
    SetResubmitted --> NotifyResubmit[Notify Procurement<br/>CC: Requestor<br/>PR resubmitted with changes]
    NotifyResubmit --> BackToStage2[["→ Return to<br/>STAGE 2:<br/>Procurement Review"]]
    
    %% Requestor Cancellation (Far Right)
    ViewNotes -.->|Or cancel<br/>instead| ReqCancel5{Cancel?}
    ReqCancel5 -.->|Yes| ReqCancelConfirm5[CANCELED<br/>by Requestor]
    ReqCancelConfirm5 -.-> ToStage7[["→ Stage 7"]]
    
    %% Styling
    classDef entryNode fill:#ffe0b2,stroke:#ef6c00,stroke-width:3px
    classDef reviewNode fill:#fff9c4,stroke:#f9a825,stroke-width:2px
    classDef editNode fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px,stroke-dasharray: 5 5
    classDef processNode fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    classDef errorNode fill:#ffcdd2,stroke:#c62828,stroke-width:2px
    classDef nextStage fill:#ffe0b2,stroke:#ef6c00,stroke-width:3px
    
    classDef cancelNode fill:#ffebee,stroke:#c62828,stroke-width:1px,stroke-dasharray: 3 3
    
    class EntryProc,EntryApprover entryNode
    class RequestorReview,ValidateChanges reviewNode
    class EditPR,EditDetails,CannotEdit,SaveChanges editNode
    class ViewNotes,SetResubmitted,NotifyResubmit processNode
    class ShowErrors errorNode
    class ReqCancel5,ReqCancelConfirm5 cancelNode
    class BackToStage2,ToStage7 nextStage
            </pre>
        </div>

        <div class="info-box">
            <h3>Requestor Edit Permissions (REVISION_REQUIRED Status)</h3>
            <div class="edit-permissions">
                <div class="perm-col can-edit">
                    <h4>✅ CAN EDIT</h4>
                    <ul>
                        <li><strong>Organization</strong></li>
                        <li><strong>Department</strong></li>
                        <li><strong>Description</strong></li>
                        <li><strong>Site</strong></li>
                        <li><strong>Expense Type</strong></li>
                        <li><strong>Estimated Amount</strong></li>
                        <li><strong>Currency</strong></li>
                        <li><strong>Urgency Level</strong> ⭐</li>
                        <li><strong>Required Date</strong> ⭐</li>
                        <li><strong>Preferred Vendor</strong></li>
                        <li><strong>Line Items</strong> (add, edit, delete)</li>
                        <li><strong>Attachments</strong></li>
                        <li><strong>Vehicle</strong> (if applicable)</li>
                    </ul>
                    <p style="font-size: 12px; color: #666;">⭐ = Can edit in R&R but NOT in Procurement Review</p>
                </div>
                <div class="perm-col cannot-edit">
                    <h4>❌ CANNOT EDIT (Canonical Fields)</h4>
                    <ul>
                        <li><strong>Created By</strong> (original requestor)</li>
                        <li><strong>Created Date</strong></li>
                        <li><strong>History/Audit Trail</strong></li>
                        <li><strong>PR Number</strong></li>
                        <li><strong>Approval History</strong></li>
                        <li><strong>Previous Status Changes</strong></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="info-box" style="background-color: #e1f5fe; border-left-color: #0277bd;">
            <h3>Comparison: Procurement Edit vs Requestor Edit</h3>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                <tr style="background-color: #b3e5fc;">
                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Field</th>
                    <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Procurement Edit<br/>(SUBMITTED)</th>
                    <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Requestor Edit<br/>(REVISION_REQUIRED)</th>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;">Organization</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center; background-color: #c8e6c9;">✓ Yes</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center; background-color: #c8e6c9;">✓ Yes</td>
                </tr>
                <tr style="background-color: #f9f9f9;">
                    <td style="padding: 10px; border: 1px solid #ddd;">Department, Description, Site</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center; background-color: #c8e6c9;">✓ Yes</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center; background-color: #c8e6c9;">✓ Yes</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;">Expense Type, Amount, Currency</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center; background-color: #c8e6c9;">✓ Yes</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center; background-color: #c8e6c9;">✓ Yes</td>
                </tr>
                <tr style="background-color: #f9f9f9;">
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>Urgency Level</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center; background-color: #ffcdd2;">✗ No</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center; background-color: #c8e6c9;"><strong>✓ Yes</strong></td>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>Required Date</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center; background-color: #ffcdd2;">✗ No</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center; background-color: #c8e6c9;"><strong>✓ Yes</strong></td>
                </tr>
                <tr style="background-color: #f9f9f9;">
                    <td style="padding: 10px; border: 1px solid #ddd;">Preferred Vendor, Line Items, Attachments</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center; background-color: #c8e6c9;">✓ Yes</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center; background-color: #c8e6c9;">✓ Yes</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;">Created By, Created Date</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center; background-color: #ffcdd2;">✗ No</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center; background-color: #ffcdd2;">✗ No</td>
                </tr>
            </table>
            <p style="margin-top: 10px; font-size: 14px;"><strong>Key Difference:</strong> Requestor can edit Urgency Level and Required Date during revision, but Procurement cannot edit these fields during SUBMITTED review.</p>
        </div>

        <div class="info-box" style="background-color: #e8f5e9; border-left-color: #388e3c;">
            <h3>Revision Workflow Options</h3>
            <ol>
                <li>
                    <strong>Resubmit with Changes:</strong>
                    <ul>
                        <li>Requestor makes required changes based on notes</li>
                        <li>Status changes to RESUBMITTED</li>
                        <li>PR returns to Stage 2 (Procurement Review)</li>
                        <li>Procurement reviews again from SUBMITTED status</li>
                        <li>All validation rules apply to changes</li>
                    </ul>
                </li>
                <li>
                    <strong>Cancel PR Instead:</strong>
                    <ul>
                        <li>Requestor decides not to proceed with PR</li>
                        <li>Status changes to CANCELED</li>
                        <li>Notification sent to procurement</li>
                        <li>PR moves to Stage 7 (Terminal State)</li>
                        <li>PR not deleted from database (audit trail preserved)</li>
                    </ul>
                </li>
            </ol>
        </div>

        <div class="info-box" style="background-color: #fce4ec; border-left-color: #c2185b;">
            <h3>Who Can Take Actions in REVISION_REQUIRED Status?</h3>
            <p><strong>ONLY the Requestor or Administrator can take actions in this stage:</strong></p>
            <ul>
                <li><strong>Requestor (Level 5):</strong> ✓ Can edit their own PR and resubmit or cancel</li>
                <li><strong>Level 1 (Administrator):</strong> ✓ Can edit, resubmit, or cancel any PR (superuser)</li>
                <li><strong>Procurement (Level 3):</strong> ✗ CANNOT edit or take actions - must wait for requestor</li>
                <li><strong>Approvers (Level 2, 4):</strong> ✗ CANNOT edit or take actions - can only view</li>
            </ul>
        </div>

        <div class="info-box" style="background-color: #fff3e0; border-left-color: #f57c00;">
            <h3>Important Notes</h3>
            <ul>
                <li><strong>Iterative Editing:</strong> Requestor can edit multiple times before resubmitting</li>
                <li><strong>Validation Required:</strong> All validation rules apply when resubmitting (same as initial creation)</li>
                <li><strong>History Preserved:</strong> All changes are tracked in audit trail but cannot be modified by requestor</li>
                <li><strong>Last Updated:</strong> Timestamp automatically updated with each save</li>
                <li><strong>Status RESUBMITTED:</strong> Temporary status that immediately returns to SUBMITTED for procurement review</li>
                <li><strong>Organization Change Allowed:</strong> Unlike procurement review restrictions on some fields, requestor CAN change urgency and required date</li>
            </ul>
        </div>

        <div class="navigation" style="margin-top: 30px;">
            <a href="PR_Flow_4_Approval.html">← Stage 4 (Approval)</a>
            <a href="PR_Flow_Master_Overview.html">Master Overview</a>
            <a href="PR_Flow_2_Procurement_Review.html">Returns to: Stage 2 (Procurement Review) →</a>
        </div>
    </div>
</body>
</html>

